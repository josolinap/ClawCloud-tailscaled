# Enhanced Dockerfile for Tailscale Exit Node – free‑tier ready
# Optimised for minimal RAM/CPU (0.1‑0.5 CPU, 256‑512 MiB RAM)

FROM alpine:3.19 AS base

# Install only the packages we really need
RUN apk add --no-cache \
    curl \
    iptables ip6tables iproute2 \
    ca-certificates tzdata procps bash \
    nginx nginx-mod-http-headers-more \
    supervisor coreutils bc

# -----------------------------------------------------------------
# Install Tailscale (static binary) – keep it lean
# -----------------------------------------------------------------
ENV TAILSCALE_VERSION=1.76.1
RUN curl -fsSL \
    "https://pkgs.tailscale.com/stable/tailscale_${TAILSCALE_VERSION}_linux_amd64.tgz" \
    | tar -xzC /tmp \
    && mv /tmp/tailscale_${TAILSCALE_VERSION}_linux_amd64/tailscale* /usr/local/bin/ \
    && rm -rf /tmp/tailscale_*

# -----------------------------------------------------------------
# Create a non‑root user that will run everything
# -----------------------------------------------------------------
RUN addgroup -S tailscale && adduser -S tailscale -G tailscale

# -----------------------------------------------------------------
# Create required directories with correct ownership
# -----------------------------------------------------------------
RUN mkdir -p /var/lib/tailscale /var/run/tailscale /var/log/tailscale \
              /var/log/nginx /var/log/supervisor \
    && chown -R tailscale:tailscale /var/lib/tailscale /var/run/tailscale \
                                    /var/log/tailscale /var/log/nginx /var/log/supervisor

# -----------------------------------------------------------------
# Copy configuration & helper scripts
# -----------------------------------------------------------------
COPY nginx.conf            /etc/nginx/nginx.conf
COPY supervisord.conf     /etc/supervisor/supervisord.conf
COPY docker-entrypoint.sh /usr/local/bin/docker-entrypoint.sh
COPY bandwidth-monitor.sh /usr/local/bin/bandwidth-monitor.sh
COPY health-check.sh      /usr/local/bin/health-check.sh
RUN chmod +x /usr/local/bin/docker-entrypoint.sh \
           /usr/local/bin/bandwidth-monitor.sh \
           /usr/local/bin/health-check.sh

# -----------------------------------------------------------------
# Runtime defaults – these are the values the entrypoint will read
# -----------------------------------------------------------------
ENV TS_USERSPACE=true \          # <‑‑ **force userspace** (no privileged net‑admin)
    TS_STATE_DIR=/var/lib/tailscale \
    TS_SOCKET=/var/run/tailscale/tailscaled.sock \
    DISABLE_IPV6=true \
    TZ=UTC \
    NGINX_WORKER_PROCESSES=1 \
    NGINX_WORKER_CONNECTIONS=512

# -----------------------------------------------------------------
# Health‑check – runs inside the container
# -----------------------------------------------------------------
HEALTHCHECK --interval=30s --timeout=10s --start-period=60s --retries=5 \
    CMD /usr/local/bin/health-check.sh

# -----------------------------------------------------------------
# Use the custom entrypoint (starts supervisord which launches nginx & tailscale)
# -----------------------------------------------------------------
ENTRYPOINT ["/usr/local/bin/docker-entrypoint.sh"]
