# Supervisord configuration for Tailscale Exit Node
# Optimized for claw.cloud free tier resource constraints

[supervisord]
nodaemon=true
loglevel=info
logfile=/var/log/supervisor/supervisord.log
logfile_maxbytes=10MB
logfile_backups=3
pidfile=/var/run/supervisord.pid
childlogdir=/var/log/supervisor
user=root

[supervisorctl]
serverurl=unix:///var/run/supervisor.sock

[unix_http_server]
file=/var/run/supervisor.sock
chmod=0700

[rpcinterface:supervisor]
supervisor.rpcinterface_factory = supervisor.rpcinterface:make_main_rpcinterface

# Tailscale daemon
[program:tailscaled]
command=tailscaled --state=%(ENV_TS_STATE_DIR)s --socket=%(ENV_TS_SOCKET)s --port=41641
user=root
autostart=true
autorestart=true
startretries=10
startsecs=5
stdout_logfile=/var/log/tailscale/tailscaled.log
stdout_logfile_maxbytes=10MB
stdout_logfile_backups=3
stderr_logfile=/var/log/tailscale/tailscaled_error.log
stderr_logfile_maxbytes=10MB
stderr_logfile_backups=3
environment=TS_STATE_DIR="/var/lib/tailscale",TS_SOCKET="/var/run/tailscale/tailscaled.sock"

# Tailscale connection setup
[program:tailscale-up]
command=bash -c 'sleep 10 && tailscale --socket=%(ENV_TS_SOCKET)s up --authkey=%(ENV_TS_AUTHKEY)s --hostname=%(ENV_TS_HOSTNAME)s %(ENV_TS_EXTRA_ARGS)s --timeout=60s'
user=root
autostart=true
autorestart=false
startretries=5
startsecs=0
stdout_logfile=/var/log/tailscale/tailscale-up.log
stdout_logfile_maxbytes=5MB
stdout_logfile_backups=2
stderr_logfile=/var/log/tailscale/tailscale-up_error.log
stderr_logfile_maxbytes=5MB
stderr_logfile_backups=2
environment=TS_SOCKET="/var/run/tailscale/tailscaled.sock",TS_AUTHKEY="%(ENV_TAILSCALE_AUTHKEY)s",TS_HOSTNAME="%(ENV_TS_HOSTNAME)s",TS_EXTRA_ARGS="%(ENV_TS_EXTRA_ARGS)s"

# Nginx web server
[program:nginx]
command=nginx -g "daemon off;"
user=root
autostart=true
autorestart=true
startretries=5
startsecs=3
stdout_logfile=/var/log/nginx/nginx.log
stdout_logfile_maxbytes=10MB
stdout_logfile_backups=3
stderr_logfile=/var/log/nginx/nginx_error.log
stderr_logfile_maxbytes=10MB
stderr_logfile_backups=3

# Bandwidth monitoring (optional)
[program:bandwidth-monitor]
command=/usr/local/bin/bandwidth-monitor.sh
user=root
autostart=true
autorestart=true
startretries=3
startsecs=10
stdout_logfile=/var/log/tailscale/bandwidth-monitor.log
stdout_logfile_maxbytes=5MB
stdout_logfile_backups=2
stderr_logfile=/var/log/tailscale/bandwidth-monitor_error.log
stderr_logfile_maxbytes=5MB
stderr_logfile_backups=2